cache:
  paths:
    - maven.repository/
 
variables:
  MAVEN_OPTS: "--batch-mode -Dmaven.repo.local=maven.repository -Dorg.slf4j.simpleLogger.log.org.apache.maven.cli.transfer.Slf4jMavenTransferListener=WARN"
 
.base-job: &base-job
  before_script:
    - apt-get update
    - apt-get install -qy maven openjdk-8-jdk libvulkan1 libvulkan-dev vulkan-utils
  script:
    - mvn package
    - mvn test
    - mvn test -Dtest=ExampleRunner

scenery-nvidia:
  image: nvidia/cuda:latest
  <<: *base-job
  after_script:
    - nvidia-smi
  tags:
    - cuda
    - intel

scenery-amd:
  image: rocm/rocm-terminal
  <<: *base-job
  variables:
    SUDO: "sudo"
    GPURUN: "sudo su -m - rocm-user -c"
  before_script:
    # The rocm docker container requires the user to be in the video group which
    # can usually be set via docker's --group-add option. GitLab-Runner currently
    # has no known option for doing that. Therefore, it manually has to happen in
    # the job description. 
    - $SUDO usermod -a -G video rocm-user
    - $SUDO apt-get -qy update
    - $SUDO apt-get -qy install sysbench
  after_script:
    - rocm-smi
  tags:
    - amd
    - rocm


