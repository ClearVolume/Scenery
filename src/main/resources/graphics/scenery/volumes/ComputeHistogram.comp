#version 450
#extension GL_EXT_debug_printf : enable


layout (local_size_x = 16, local_size_y = 16) in;
layout (set = 0, binding = 0, r16f) uniform image3D Volume16Bit;
layout (set = 1, binding = 0, r8) uniform image3D Volume8Bit;
layout (set = 2, binding = 0, r32i) uniform iimage3D Histogram;

layout(set = 3, binding = 0) uniform ShaderProperties {
    bool volumeIs8Bit;
    int numVoxels;
    float maxDisplayVal;
    float minDisplayVal;
    int numBins;
};

ivec2 debug_pixel = ivec2(512,512);


void main() {

    if(gl_GlobalInvocationID.xy == debug_pixel){
        debugPrintfEXT("Hello World!!!!!!!!!!!!!!!!!!!!!!!!!!");
    }

    float binSize = (maxDisplayVal - minDisplayVal) / numBins;

    for(int i = 0; i < numVoxels; i++) {
        float val;

        if(volumeIs8Bit) {
            val = imageLoad(Volume8Bit, ivec3(gl_GlobalInvocationID.x, gl_GlobalInvocationID.y, i)).x * pow(2,8) ;
        } else {
            val = imageLoad(Volume16Bit, ivec3(gl_GlobalInvocationID.x, gl_GlobalInvocationID.y, i)).x * pow(2,16);
        }

        if(val >= minDisplayVal && val <= maxDisplayVal) {
            int binID = int(floor(val / binSize));

            int ret = imageAtomicAdd(Histogram, ivec3(binID, 0, 0), 1);
            if( binID == 221 && ret != 0){
                debugPrintfEXT("Invocation ID: (%d, %d). Incremented the bin %d, prev value was %d", gl_GlobalInvocationID.xy, binID, ret);
            }
        }
    }
}
